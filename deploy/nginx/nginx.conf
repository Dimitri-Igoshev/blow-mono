# /etc/nginx/nginx.conf

events {}

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  sendfile        on;
  tcp_nopush      on;
  tcp_nodelay     on;
  keepalive_timeout  65;
  types_hash_max_size 2048;

  # DNS резолвер для docker-сервисов (backend и т.д.)
  resolver 127.0.0.11 ipv6=off valid=30s;
  resolver_timeout 5s;

  # Вебсокеты
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  # Префикс для проксирования в backend:
  # - /api и /uploads отдаем "как есть" (без добавления /api)
  # - всё остальное уходит на /api/<исходный путь>
  map $uri $backend_api_prefix {
    ~^/api(?:/|$)      "";
    ~^/uploads(?:/|$)  "";
    default            "/api";
  }

  client_max_body_size 50m;

  # ===== HTTP -> HTTPS редирект =====
  server {
    listen 80;
    listen [::]:80;
    server_name api.kutumba.ru;

    # Для certbot challenge
    location ^~ /.well-known/acme-challenge/ {
      root /var/www/certbot;
      try_files $uri =404;
    }

    # Редирект на https
    location / {
      return 301 https://$host$request_uri;
    }
  }

  # ===== HTTPS сервер =====
  server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.kutumba.ru;

    # Сертификаты (в твоём entrypoint они копируются сюда)
    ssl_certificate     /etc/letsencrypt/live/kutumba.ru/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/kutumba.ru/privkey.pem;

    # Базовые SSL-настройки (минимальные, можно усилить при желании)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    # Для certbot challenge (на всякий)
    location ^~ /.well-known/acme-challenge/ {
      root /var/www/certbot;
      try_files $uri =404;
    }

    # --- Главный прокси-блок ---
    # ВАЖНО: добавляем $request_uri, иначе при переменной в proxy_pass путь не приклеится
    location / {
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;

      # Таймауты по вкусу
      proxy_connect_timeout   5s;
      proxy_send_timeout     60s;
      proxy_read_timeout     60s;

      proxy_pass http://backend:4000$backend_api_prefix$request_uri;
      #                                 └──── префикс из map       └──── полный исходный путь
      # Примеры:
      #  /uploads/a.webp -> "" + /uploads/a.webp -> /uploads/a.webp
      #  /api/users      -> "" + /api/users      -> /api/users
      #  /auth/login     -> "/api" + /auth/login -> /api/auth/login
    }
  }
}
