# /etc/nginx/nginx.conf

events {}

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  sendfile        on;
  tcp_nopush      on;
  tcp_nodelay     on;
  keepalive_timeout 65;
  types_hash_max_size 2048;

  resolver 127.0.0.11 ipv6=off valid=30s;
  resolver_timeout 5s;

  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  client_max_body_size 50m;

  # =======================
  # :80 → :443
  # =======================

  server {
    listen 80;
    listen [::]:80;
    server_name blow.ru;

    location ^~ /.well-known/acme-challenge/ {
      root /var/www/certbot;
      try_files $uri =404;
    }

    return 301 https://$host$request_uri;
  }

  server {
    listen 80;
    listen [::]:80;
    server_name admin.blow.ru;

    location ^~ /.well-known/acme-challenge/ {
      root /var/www/certbot;
      try_files $uri =404;
    }

    return 301 https://$host$request_uri;
  }

  server {
    listen 80;
    listen [::]:80;
    server_name api.blow.ru;

    location ^~ /.well-known/acme-challenge/ {
      root /var/www/certbot;
      try_files $uri =404;
    }

    return 301 https://$host$request_uri;
  }

  # =======================
  # HTTPS servers
  # =======================

  # ---- Front: blow.ru ----
  server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name blow.ru;

    ssl_certificate     /etc/letsencrypt/live/blow.ru/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/blow.ru/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    location ^~ /.well-known/acme-challenge/ {
      root /var/www/certbot;
      try_files $uri =404;
    }

    location / {
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;

      proxy_read_timeout 60s;
      proxy_send_timeout 60s;
      proxy_connect_timeout 5s;

      proxy_pass http://frontend:3000;
    }
  }

  # ---- Admin: admin.blow.ru ----
  server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name admin.blow.ru;

    ssl_certificate     /etc/letsencrypt/live/blow.ru/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/blow.ru/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    location ^~ /.well-known/acme-challenge/ {
      root /var/www/certbot;
      # try_files $uri =404;
      try_files $uri /index.html;
    }

    # Внешний nginx просто проксирует.
    # Fallback для SPA должен быть настроен ВНУТРИ контейнера `admin`
    # (try_files $uri $uri/ /index.html; в его nginx/сервере).
    location / {
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;

      proxy_read_timeout 60s;
      proxy_send_timeout 60s;
      proxy_connect_timeout 5s;

      proxy_pass http://admin:80;
      try_files $uri /index.html;
    }
  }

  # ---- API & Media: api.blow.ru ----
  server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.blow.ru;

    ssl_certificate     /etc/letsencrypt/live/blow.ru/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/blow.ru/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    location ^~ /.well-known/acme-challenge/ {
      root /var/www/certbot;
      try_files $uri =404;
    }

    # Медиа из корня домена: https://api.blow.ru/<дата>/file.webp
    location / {
      alias /app/uploads/;
      autoindex off;
      expires 7d;
      add_header Cache-Control "public, max-age=604800";
      try_files $uri =404;
    }

    # API по /api — без кэша
    location ^~ /api/ {
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;

      add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate" always;
      add_header Pragma "no-cache" always;
      add_header Expires "0" always;

      proxy_read_timeout 60s;
      proxy_send_timeout 60s;
      proxy_connect_timeout 5s;

      proxy_pass http://backend:4000;
    }
  }
}
