events {}

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  sendfile        on;
  tcp_nopush      on;
  tcp_nodelay     on;
  keepalive_timeout 65;
  types_hash_max_size 2048;

  # DNS от Docker для обращения к сервисам по имени
  resolver 127.0.0.11 ipv6=off valid=30s;
  resolver_timeout 5s;

  # Вебсокеты
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  client_max_body_size 50m;

  # =======================
  # HTTP :80 → HTTPS :443
  # =======================

  server {
    listen 80;
    listen [::]:80;
    server_name kutumba.ru;

    location ^~ /.well-known/acme-challenge/ {
      root /var/www/certbot;
      try_files $uri =404;
    }

    location / { return 301 https://$host$request_uri; }
  }

  server {
    listen 80;
    listen [::]:80;
    server_name admin.kutumba.ru;

    location ^~ /.well-known/acme-challenge/ {
      root /var/www/certbot;
      try_files $uri =404;
    }

    location / { return 301 https://$host$request_uri; }
  }

  server {
    listen 80;
    listen [::]:80;
    server_name api.kutumba.ru;

    location ^~ /.well-known/acme-challenge/ {
      root /var/www/certbot;
      try_files $uri =404;
    }

    location / { return 301 https://$host$request_uri; }
  }

  # =======================
  # HTTPS servers
  # =======================

  # ---- Front: kutumba.ru ----
  server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name kutumba.ru;

    ssl_certificate     /etc/letsencrypt/live/kutumba.ru/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/kutumba.ru/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    location ^~ /.well-known/acme-challenge/ {
      root /var/www/certbot;
      try_files $uri =404;
    }

    location / {
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;

      # предположим фронт слушает :3000
      proxy_pass http://frontend:3000;
    }
  }

  # ---- Admin: admin.kutumba.ru ----
  server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name admin.kutumba.ru;

  ssl_certificate     /etc/letsencrypt/live/kutumba.ru/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/kutumba.ru/privkey.pem;
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_prefer_server_ciphers on;

  location ^~ /.well-known/acme-challenge/ {
    root /var/www/certbot;
    try_files $uri =404;
  }

  location / {
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    proxy_pass http://admin:80;   # <-- ВОТ ЭТО ГЛАВНОЕ
  }
}

  # ---- API & Media: api.kutumba.ru ----
  server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.kutumba.ru;

    ssl_certificate     /etc/letsencrypt/live/kutumba.ru/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/kutumba.ru/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    location ^~ /.well-known/acme-challenge/ {
      root /var/www/certbot;
      try_files $uri =404;
    }

    # Медиа из корня домена: https://api.kutumba.ru/<дата>/file.webp
    # Раздаём напрямую с тома (нужен volume в nginx-сервисе: uploads_data:/app/uploads:ro)
    location / {
      alias /app/uploads/;
      autoindex off;
      # кэш на 7 дней (опционально)
      expires 7d;
      add_header Cache-Control "public, max-age=604800";
      try_files $uri =404;
    }

    # Бэкенд по /api
    location ^~ /api/ {
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;

      proxy_pass http://backend:4000;
    }
  }
}
