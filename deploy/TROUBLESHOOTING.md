# Production troubleshooting checklist

Если сайт недоступен по доменному имени или по IP-адресу, выполните следующие шаги.

## 1. Проверить состояние контейнеров

```bash
docker compose ps
```

Убедитесь, что контейнеры `frontend`, `admin`, `backend`, `mongo` и `nginx` находятся в состоянии `running`. Если какой-то контейнер перезапускается или остановлен, посмотрите его логи:

```bash
docker compose logs --tail=200 <имя_сервиса>
```

## 2. Проверить, что Nginx слушает нужные порты

Контейнер `nginx` должен пробрасывать наружу порты `80` и `443`, как описано в [`docker-compose.yml`](../docker-compose.yml). Если по IP-адресу нет ответа, посмотрите, что происходит внутри контейнера:

```bash
docker compose exec nginx ss -tulpn
```

Команда покажет, слушает ли Nginx порты `80` и `443`. Одновременно проверьте наличие ошибок в конфигурации:

```bash
docker compose exec nginx nginx -t
```

Если тест конфигурации проходит, перезапустите контейнер:

```bash
docker compose restart nginx
```

## 3. Тесты изнутри сети Docker

Сделайте запросы к бекенду и фронтенду, находясь внутри контейнера `nginx`.

```bash
docker compose exec nginx curl -I http://frontend:3000
docker compose exec nginx curl -I http://admin:80
docker compose exec nginx curl -I http://backend:4000/api
```

Подставьте любой известный рабочий эндпоинт бекенда (например `/api/auth/status`). Если ответы приходят, значит сервисы доступны изнутри сети Docker и проблема, вероятно, в проксировании наружу или в DNS.

## 4. Проверить сетевые ограничения хоста

* Убедитесь, что фаервол (например, `ufw`) не блокирует порты 80/443:

  ```bash
  sudo ufw status
  ```

* Проверьте, что хостовая машина вообще слушает порты:

  ```bash
  sudo ss -tulpn | grep -E ':80|:443'
  ```

Если портов не видно, проблема в пробросе из Docker или в самом Nginx.

## 5. Проверить DNS и внешние запросы

* Сделайте запрос по IP-адресу и домену напрямую с другой машины:

  ```bash
  curl -v http://212.193.30.131
  curl -v https://kutumba.ru --resolve kutumba.ru:443:212.193.30.131
  ```

  Вторая команда обходить DNS и позволяет увидеть, отвечает ли сервер по HTTPS.

* Если HTTPS недоступен, проверьте, что сертификаты Let’s Encrypt присутствуют в каталоге `deploy/nginx` (они монтируются в контейнер). При необходимости запустите обновление сертификата:

  ```bash
  docker compose run --rm certbot renew
  docker compose exec nginx nginx -s reload
  ```

## 6. Смотреть системные логи

Если контейнеры в порядке, но на уровне хоста нет подключения, проверьте системные журналы (`journalctl -u docker`, `journalctl -u nginx`, `dmesg`), а также наличие правил NAT/iptables, которые могут блокировать трафик.

Следуя этой последовательности, вы сможете определить, на каком уровне возникает проблема: в самих приложениях, Nginx, проксировании Docker или сетевой конфигурации сервера.
